'use client';

import { useState } from 'react';
import { format, addDays, startOfWeek, isSameDay, isToday } from 'date-fns';
import { ja } from 'date-fns/locale';
import { ChevronLeft, ChevronRight, Plus } from 'lucide-react';
import { Post } from '@/lib/types';
import { PostCard } from './PostCard';
import { Button } from '@/components/ui/Button';

interface WeekViewProps {
  posts: Post[];
  onPostClick: (post: Post) => void;
  onSlotClick: (date: Date) => void;
  onPostMove?: (postId: string, newDate: Date) => void;
}

export function WeekView({ posts, onPostClick, onSlotClick, onPostMove }: WeekViewProps) {
  const [currentWeekStart, setCurrentWeekStart] = useState(
    startOfWeek(new Date(), { weekStartsOn: 0 })
  );
  const [draggedPost, setDraggedPost] = useState<Post | null>(null);
  const [dragOverSlot, setDragOverSlot] = useState<string | null>(null);

  // ãƒ‡ãƒãƒƒã‚°
  console.log('ğŸ“… WeekView received posts:', posts);
  console.log('ğŸ“… Current week start:', currentWeekStart);

  // 10æœˆ30æ—¥ã®æŠ•ç¨¿ã‚’ç¢ºèª
  const oct30Posts = posts.filter(p => {
    const dateStr = p.state === 'published' ? p.published_at : p.scheduled_at;
    if (!dateStr) return false;
    const date = new Date(dateStr);
    return date.getDate() === 30 && date.getMonth() === 9 && date.getFullYear() === 2025;
  });
  console.log(`ğŸ” WeekView Oct 30 posts: ${oct30Posts.length} posts`);
  oct30Posts.forEach(p => {
    const dateStr = p.state === 'published' ? p.published_at : p.scheduled_at;
    const date = new Date(dateStr!);
    console.log(`  ğŸ“Œ ${p.threads_post_id}: ${date.getHours()}æ™‚${String(date.getMinutes()).padStart(2, '0')}åˆ† - ${p.caption?.substring(0, 50)}`);
  });

  const weekDays = Array.from({ length: 7 }, (_, i) => addDays(currentWeekStart, i));
  // Buffer style: 1æ™‚é–“ã”ã¨ã«è¡¨ç¤ºï¼ˆ0:00-23:00 = 24æ™‚é–“ï¼‰
  const timeSlots = Array.from({ length: 24 }, (_, i) => {
    const hour = i; // 0æ™‚ã‹ã‚‰é–‹å§‹
    return {
      hour: hour,
      label: `${hour}:00`,
    };
  });

  const goToPreviousWeek = () => {
    setCurrentWeekStart((prev) => addDays(prev, -7));
  };

  const goToNextWeek = () => {
    setCurrentWeekStart((prev) => addDays(prev, 7));
  };

  const goToToday = () => {
    setCurrentWeekStart(startOfWeek(new Date(), { weekStartsOn: 0 }));
  };

  // ç‰¹å®šã®æ™‚é–“å¸¯ã®æŠ•ç¨¿ã‚’å–å¾—ï¼ˆ1æ™‚é–“å˜ä½ï¼‰
  const getPostsForSlot = (date: Date, hour: number): Post[] => {
    const filtered = posts.filter((post) => {
      // é…ä¿¡æ¸ˆã¿ã®å ´åˆã¯published_atã€äºˆç´„æ¸ˆã¿ã®å ´åˆã¯scheduled_atã‚’ä½¿ç”¨
      const dateStr = post.state === 'published' && post.published_at
        ? post.published_at
        : post.scheduled_at;

      if (!dateStr) {
        console.log('âš ï¸ Post has no date:', post.id, 'state:', post.state);
        return false;
      }

      const postDate = new Date(dateStr);
      const isSame = isSameDay(postDate, date);
      const postHour = postDate.getHours();
      const hourMatch = postHour === hour;

      if (isSame && hourMatch) {
        console.log('âœ… Matched post:', {
          id: post.id,
          state: post.state,
          date: postDate.toISOString(),
          hour: postHour,
          slotHour: hour,
          caption: post.caption?.substring(0, 30)
        });
      }

      return isSame && hourMatch;
    });

    return filtered;
  };

  // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  const handleDragStart = (e: React.DragEvent, post: Post) => {
    setDraggedPost(post);
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', post.id);
  };

  const handleDragOver = (e: React.DragEvent, slotKey: string) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    setDragOverSlot(slotKey);
  };

  const handleDragLeave = () => {
    setDragOverSlot(null);
  };

  const handleDrop = (e: React.DragEvent, newDate: Date) => {
    e.preventDefault();
    if (draggedPost && onPostMove) {
      onPostMove(draggedPost.id, newDate);
    }
    setDraggedPost(null);
    setDragOverSlot(null);
  };

  const handleDragEnd = () => {
    setDraggedPost(null);
    setDragOverSlot(null);
  };

  return (
    <div className="flex flex-col h-full p-6">
      {/* Header - Buffer style */}
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-4">
          <h2 className="text-xl font-semibold text-foreground">
            {format(currentWeekStart, 'yyyyå¹´Mæœˆ', { locale: ja })}
          </h2>
          <div className="flex items-center gap-1">
            <button
              onClick={goToPreviousWeek}
              className="p-2 hover:bg-secondary rounded-md transition-colors"
              aria-label="å‰ã®é€±"
            >
              <ChevronLeft className="w-5 h-5 text-muted-foreground" />
            </button>
            <button
              onClick={goToNextWeek}
              className="p-2 hover:bg-secondary rounded-md transition-colors"
              aria-label="æ¬¡ã®é€±"
            >
              <ChevronRight className="w-5 h-5 text-muted-foreground" />
            </button>
          </div>
        </div>
        <button
          onClick={goToToday}
          className="px-4 py-2 text-sm font-medium text-foreground hover:bg-secondary rounded-lg transition-colors border border-border"
        >
          ä»Šæ—¥
        </button>
      </div>

      {/* Calendar Grid - Buffer inspired */}
      <div className="flex-1 overflow-auto mb-6">
        <div className="min-w-[1000px]">
          {/* Day Headers */}
          <div className="flex gap-3 mb-3 pl-[76px]">
            {weekDays.map((day) => {
              const dayIsToday = isToday(day);
              return (
                <div
                  key={day.toISOString()}
                  className={`flex-1 text-center pb-2 ${
                    dayIsToday
                      ? 'border-b-2 border-primary'
                      : 'border-b border-border'
                  }`}
                >
                  <div className="text-[11px] font-semibold text-muted-foreground uppercase tracking-wider mb-0.5">
                    {format(day, 'EEE', { locale: ja })}
                  </div>
                  <div
                    className={`text-lg font-semibold ${
                      dayIsToday
                        ? 'text-primary'
                        : 'text-foreground'
                    }`}
                  >
                    {format(day, 'd')}
                  </div>
                </div>
              );
            })}
          </div>

          {/* Buffer-style: æ—¥ã”ã¨ã«æŠ•ç¨¿ã‚’ãƒªã‚¹ãƒˆè¡¨ç¤º */}
          <div className="flex gap-4">
            {weekDays.map((day) => {
              const dayIsToday = isToday(day);
              const dayIsPast = day < new Date() && !dayIsToday;

              // ãã®æ—¥ã®ã™ã¹ã¦ã®æŠ•ç¨¿ã‚’å–å¾—
              const dayPosts = posts.filter((post) => {
                const dateStr = post.state === 'published' && post.published_at
                  ? post.published_at
                  : post.scheduled_at;
                if (!dateStr) return false;
                const postDate = new Date(dateStr);
                return isSameDay(postDate, day);
              }).sort((a, b) => {
                // æ™‚åˆ»é †ã«ã‚½ãƒ¼ãƒˆ
                const dateA = new Date(a.published_at || a.scheduled_at || 0);
                const dateB = new Date(b.published_at || b.scheduled_at || 0);
                return dateA.getTime() - dateB.getTime();
              });

              return (
                <div
                  key={day.toISOString()}
                  className="flex-1 min-w-0"
                >
                  {/* æ—¥ä»˜ãŒä»Šæ—¥ãªã‚‰å¼·èª¿ */}
                  <div className={`mb-4 pb-2 border-b-2 ${dayIsToday ? 'border-primary' : 'border-transparent'}`}></div>

                  {/* æŠ•ç¨¿ãƒªã‚¹ãƒˆ */}
                  <div className="space-y-3">
                    {dayPosts.length === 0 ? (
                      <div
                        className={`rounded-lg border-2 border-dashed ${
                          dayIsPast ? 'border-gray-200 bg-gray-50' : 'border-gray-300 hover:border-gray-400 bg-white cursor-pointer'
                        } p-8 text-center transition-all`}
                        onClick={() => !dayIsPast && onSlotClick(day)}
                      >
                        <Plus className="w-6 h-6 text-gray-400 mx-auto mb-2" />
                        <p className="text-sm text-gray-500">æŠ•ç¨¿ãªã—</p>
                      </div>
                    ) : (
                      dayPosts.map((post) => (
                        <div
                          key={post.id}
                          draggable
                          onDragStart={(e) => handleDragStart(e, post)}
                          onDragEnd={handleDragEnd}
                          className={`${
                            draggedPost?.id === post.id ? 'opacity-50' : 'opacity-100'
                          } cursor-move`}
                        >
                          <PostCard
                            post={post}
                            onClick={() => onPostClick(post)}
                          />
                        </div>
                      ))
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      </div>

      {/* Legend - Simplified */}
      <div className="pt-4 border-t border-border">
        <div className="flex items-center gap-6 text-xs text-muted-foreground">
          <div className="flex items-center gap-2">
            <div className="w-3 h-3 bg-card border border-border rounded"></div>
            <span>æœªæ¥ã®æ—¥</span>
          </div>
          <div className="flex items-center gap-2">
            <div className="w-3 h-3 bg-secondary border border-border rounded opacity-60"></div>
            <span>éå»ã®æ—¥</span>
          </div>
        </div>
      </div>
    </div>
  );
}
